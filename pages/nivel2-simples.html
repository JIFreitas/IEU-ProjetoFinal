<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Nível 2 - Acenda 4 Velas</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.1/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="../assets/styles/common.css" />
    <script src="../assets/scripts/common.js"></script>
    <script src="../assets/scripts/game.js"></script>
  </head>

  <body>
    <div id="hud">
      <div>Velas: <span id="candles">0</span>/4</div>
      <div id="msg">Acenda as velas na ordem: 1 → 2 → 3 → 4</div>
      <div class="hud-hint">Pressione ESC para pausar</div>
    </div>

    <div id="timer-top" class="timer-top" aria-label="Tempo restante">
      <span id="timer-text">00:00</span>
    </div>

    <div id="pause-menu" class="theme-orange">
      <h2>JOGO PAUSADO</h2>

      <div class="setting-row">
        <span>Música:</span>
        <div
          class="toggle active"
          id="music-toggle"
          onclick="togglePauseMusic()"
        >
          <div class="toggle-slider"></div>
        </div>
      </div>

      <div class="setting-row">
        <span>Volume:</span>
        <input
          type="range"
          min="0"
          max="100"
          value="40"
          id="volume-control"
          oninput="updatePauseVolume(this.value)"
        />
        <span id="vol-display">40%</span>
      </div>

      <button class="menu-btn btn-orange" onclick="resumeGame()">
        Continuar
      </button>
      <button
        class="menu-btn btn-orange"
        onclick="window.location.href='../index-simples.html'"
      >
        Menu Principal
      </button>
    </div>

    <a-scene>
      <a-sky color="#050505"></a-sky>

      <!-- Chão com nav-mesh -->
      <a-plane
        position="0 0 -5"
        rotation="-90 0 0"
        width="4"
        height="19.6"
        color="#1a1410"
        nav-mesh
      ></a-plane>

      <!-- Paredes corredor -->
      <a-box
        position="-2.5 2 -5"
        width="0.2"
        height="4"
        depth="20"
        color="#3a2510"
      ></a-box>
      <a-box
        position="2.5 2 -5"
        width="0.2"
        height="4"
        depth="20"
        color="#3a2510"
      ></a-box>
      <a-box
        position="0 2 5"
        width="6"
        height="4"
        depth="0.2"
        color="#3a2510"
      ></a-box>
      <a-box
        position="0 2 -15"
        width="6"
        height="4"
        depth="0.2"
        color="#3a2510"
      ></a-box>

      <!-- Teto -->
      <a-plane
        position="0 4 -5"
        rotation="90 0 0"
        width="6"
        height="20"
        color="#0a0a0a"
      ></a-plane>

      <!-- Velas -->
      <a-entity position="-1 1.5 -8">
        <a-cylinder
          id="candle1"
          class="candle"
          radius="0.1"
          height="0.5"
          color="#8b4513"
          data-order="1"
        ></a-cylinder>
        <a-text
          value="1"
          position="0 0.8 0"
          align="center"
          color="#ffffff"
          width="3"
        ></a-text>
        <a-sphere
          id="flame1"
          class="flame"
          visible="false"
          position="0 0.4 0"
          radius="0.15"
          color="#ff6600"
          animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 300"
        ></a-sphere>
      </a-entity>

      <a-entity position="1 1.5 -8">
        <a-cylinder
          id="candle2"
          class="candle"
          radius="0.1"
          height="0.5"
          color="#8b4513"
          data-order="2"
        ></a-cylinder>
        <a-text
          value="2"
          position="0 0.8 0"
          align="center"
          color="#ffffff"
          width="3"
        ></a-text>
        <a-sphere
          id="flame2"
          class="flame"
          visible="false"
          position="0 0.4 0"
          radius="0.15"
          color="#ff6600"
          animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 300"
        ></a-sphere>
      </a-entity>

      <a-entity position="-1 1.5 -12">
        <a-cylinder
          id="candle3"
          class="candle"
          radius="0.1"
          height="0.5"
          color="#8b4513"
          data-order="3"
        ></a-cylinder>
        <a-text
          value="3"
          position="0 0.8 0"
          align="center"
          color="#ffffff"
          width="3"
        ></a-text>
        <a-sphere
          id="flame3"
          class="flame"
          visible="false"
          position="0 0.4 0"
          radius="0.15"
          color="#ff6600"
          animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 300"
        ></a-sphere>
      </a-entity>

      <a-entity position="1 1.5 -12">
        <a-cylinder
          id="candle4"
          class="candle"
          radius="0.1"
          height="0.5"
          color="#8b4513"
          data-order="4"
        ></a-cylinder>
        <a-text
          value="4"
          position="0 0.8 0"
          align="center"
          color="#ffffff"
          width="3"
        ></a-text>
        <a-sphere
          id="flame4"
          class="flame"
          visible="false"
          position="0 0.4 0"
          radius="0.15"
          color="#ff6600"
          animation="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 300"
        ></a-sphere>
      </a-entity>

      <!-- Porta -->
      <a-box
        id="door"
        position="0 2 -15"
        width="2"
        height="3"
        depth="0.1"
        color="#663300"
      ></a-box>

      <!-- Luz -->
      <a-light type="ambient" intensity="0.2"></a-light>
      <a-light
        type="point"
        position="0 3 -8"
        intensity="0.5"
        color="#ffaa66"
      ></a-light>

      <!-- Rig -->
      <a-entity
        id="rig"
        position="0 0 2"
        clamp-bounds="minX: -2.3; maxX: 2.3; minZ: -14.8; maxZ: 4.8; margin: 0.05"
        movement-controls="speed: 0.3; fly: false; constrainToNavMesh: true"
      >
        <a-camera
          position="0 1.6 0"
          wasd-controls="enabled: false"
          look-controls="pointerLockEnabled: false"
        >
          <a-cursor
            color="#ff0000"
            fuse="true"
            fuse-timeout="800"
            raycaster="objects: .candle, #door"
          ></a-cursor>
        </a-camera>
      </a-entity>
    </a-scene>

    <audio id="bg-music" loop preload="auto">
      <source src="../assets/sounds/musica-ambiente.mp3" type="audio/mpeg" />
    </audio>

    <script>
      requireUnlockedLevel(2, "../index-simples.html");

      let candlesLit = 0;
      const candlesSpan = document.getElementById("candles");
      const msgDiv = document.getElementById("msg");

      startLevelTimer({
        seconds: 120,
        onTimeout: () => {
          msgDiv.textContent = "⏰ Tempo esgotado! A recomeçar o nível...";
          msgDiv.style.color = "#ff0000";
          setTimeout(() => location.reload(), 1500);
        },
      });

      AFRAME.registerComponent("candle-light", {
        init: function () {
          this.el.addEventListener("click", () => {
            if (this.lit) return;

            const order = parseInt(this.el.getAttribute("data-order"));

            if (order === candlesLit + 1) {
              this.lit = true;
              candlesLit++;
              candlesSpan.textContent = candlesLit;

              const flameId = "flame" + order;
              document.getElementById(flameId).setAttribute("visible", "true");

              const light = document.createElement("a-light");
              light.setAttribute("type", "point");
              light.setAttribute("intensity", "0.8");
              light.setAttribute("color", "#ff6600");
              light.setAttribute("distance", "3");
              this.el.parentElement.appendChild(light);

              msgDiv.textContent = `Vela ${order} acesa! ✓`;
              msgDiv.style.color = "#00ff00";

              if (candlesLit === 4) {
                setTimeout(() => {
                  msgDiv.textContent = "TODAS ACESAS! Clique na porta!";
                  document.getElementById("door").classList.add("unlocked");
                }, 1000);
              } else {
                setTimeout(() => {
                  msgDiv.textContent = `Acenda a vela ${candlesLit + 1}`;
                  msgDiv.style.color = "white";
                }, 1500);
              }
            } else {
              msgDiv.textContent = "ERRADO! Acenda na ordem: 1→2→3→4";
              msgDiv.style.color = "#ff0000";

              setTimeout(() => location.reload(), 2000);
            }
          });
        },
      });

      AFRAME.registerComponent("door-system", {
        init: function () {
          this.el.addEventListener("click", () => {
            if (candlesLit === 4) {
              msgDiv.textContent = "NÍVEL 2 CONCLUÍDO!";
              msgDiv.style.fontSize = "24px";

              this.el.setAttribute("animation", {
                property: "position",
                to: "0 5 -15",
                dur: 1000,
              });

              setTimeout(() => {
                stopLevelTimer();
                unlockLevel(3);
                window.location.href = "nivel3-simples.html";
              }, 2000);
            } else {
              msgDiv.textContent = "Acenda todas as 4 velas primeiro!";
              msgDiv.style.color = "#ff0000";
            }
          });
        },
      });

      document
        .querySelectorAll(".candle")
        .forEach((candle) => candle.setAttribute("candle-light", ""));
      document.getElementById("door").setAttribute("door-system", "");
    </script>
  </body>
</html>
