<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Nível 1 - Encontre 3 Chaves</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.1/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="../assets/styles/common.css" />
    <script src="../assets/scripts/common.js"></script>
    <script src="../assets/scripts/game.js"></script>
  </head>

  <body>
    <div id="hud">
      <div>Chaves: <span id="keys">0</span>/3</div>
      <div id="msg">Encontre 3 chaves para abrir a porta!</div>
      <div class="hud-hint">Pressione ESC para pausar</div>
    </div>

    <div id="timer-top" class="timer-top" aria-label="Tempo restante">
      <span id="timer-text">00:00</span>
    </div>

    <div id="pause-menu" class="theme-red">
      <h2>JOGO PAUSADO</h2>

      <div class="setting-row">
        <span>Música:</span>
        <div
          class="toggle active"
          id="music-toggle"
          onclick="togglePauseMusic()"
        >
          <div class="toggle-slider"></div>
        </div>
      </div>

      <div class="setting-row">
        <span>Volume:</span>
        <input
          type="range"
          min="0"
          max="100"
          value="40"
          id="volume-control"
          oninput="updatePauseVolume(this.value)"
        />
        <span id="vol-display">40%</span>
      </div>

      <button class="menu-btn btn-red" onclick="resumeGame()">Continuar</button>
      <button
        class="menu-btn btn-red"
        onclick="window.location.href='../index-simples.html'"
      >
        Menu Principal
      </button>
    </div>

    <a-scene>
      <a-sky color="#111"></a-sky>

      <!-- Chão com nav-mesh -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="13.7"
        height="13.7"
        color="#2a1810"
        nav-mesh
      ></a-plane>

      <!-- Paredes -->
      <a-box
        position="0 2 -7"
        width="15"
        height="4"
        depth="0.2"
        color="#4a3020"
      ></a-box>
      <a-box
        position="-7 2 0"
        width="0.2"
        height="4"
        depth="15"
        color="#4a3020"
      ></a-box>
      <a-box
        position="7 2 0"
        width="0.2"
        height="4"
        depth="15"
        color="#4a3020"
      ></a-box>
      <a-box
        position="0 2 7"
        width="15"
        height="4"
        depth="0.2"
        color="#4a3020"
      ></a-box>

      <!-- Teto -->
      <a-plane
        position="0 4 0"
        rotation="90 0 0"
        width="15"
        height="15"
        color="#1a1410"
      ></a-plane>

      <!-- CHAVES -->
      <a-sphere
        id="key1"
        class="key"
        position="-4 1.5 -5"
        radius="0.3"
        color="#FFD700"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
        animation__pulse="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 500"
      ></a-sphere>

      <a-sphere
        id="key2"
        class="key"
        position="4 1.5 -5"
        radius="0.3"
        color="#FFD700"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
        animation__pulse="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 500"
      ></a-sphere>

      <a-sphere
        id="key3"
        class="key"
        position="0 1.5 -6"
        radius="0.3"
        color="#FFD700"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
        animation__pulse="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 500"
      ></a-sphere>

      <!-- Porta -->
      <a-box
        id="door"
        position="0 2 -6.9"
        width="2"
        height="3"
        depth="0.1"
        color="#663300"
      ></a-box>
      <a-text
        id="door-text"
        value="PORTA TRANCADA"
        position="0 3.5 -6.8"
        align="center"
        color="#ff0000"
        width="5"
      ></a-text>

      <!-- Luz -->
      <a-light type="ambient" intensity="0.3"></a-light>
      <a-light
        type="point"
        position="0 3 0"
        intensity="0.8"
        color="#ffaa66"
      ></a-light>

      <!-- Rig -->
      <a-entity
        id="rig"
        position="0 0 5"
        clamp-bounds="minX: -6.85; maxX: 6.85; minZ: -6.85; maxZ: 6.85; margin: 0.05"
        movement-controls="speed: 0.3; fly: false; constrainToNavMesh: true"
      >
        <a-camera
          position="0 1.6 0"
          wasd-controls="enabled: false"
          look-controls="pointerLockEnabled: false"
        >
          <a-cursor
            color="#ff0000"
            fuse="true"
            fuse-timeout="800"
            raycaster="objects: .key, #door"
          ></a-cursor>
        </a-camera>
      </a-entity>
    </a-scene>

    <audio id="bg-music" loop preload="auto">
      <source src="../assets/sounds/musica-ambiente.mp3" type="audio/mpeg" />
    </audio>

    <script>
      let keysFound = 0;
      const keysSpan = document.getElementById("keys");
      const msgDiv = document.getElementById("msg");

      startLevelTimer({
        seconds: 90,
        onTimeout: () => {
          msgDiv.textContent = "⏰ Tempo esgotado! A recomeçar o nível...";
          msgDiv.style.color = "#ff0000";
          setTimeout(() => location.reload(), 1500);
        },
      });

      // Sistema de pegar chaves
      AFRAME.registerComponent("key-pickup", {
        init: function () {
          this.el.addEventListener("click", () => {
            if (!this.picked) {
              this.picked = true;
              keysFound++;
              keysSpan.textContent = keysFound;

              this.el.setAttribute("visible", "false");

              msgDiv.textContent = `Chave coletada! (${keysFound}/3)`;
              msgDiv.style.color = "#00ff00";

              if (keysFound === 3) {
                setTimeout(() => {
                  msgDiv.textContent = "PORTA ABERTA! Clique nela!";
                  document.getElementById("door").classList.add("unlocked");
                }, 500);
              } else {
                setTimeout(() => {
                  msgDiv.textContent = "Encontre as outras chaves!";
                  msgDiv.style.color = "white";
                }, 2000);
              }
            }
          });
        },
      });

      // Sistema de porta
      AFRAME.registerComponent("door-system", {
        init: function () {
          this.el.addEventListener("click", () => {
            if (keysFound === 3) {
              msgDiv.textContent = "NÍVEL CONCLUÍDO! Parabéns!";
              msgDiv.style.color = "#00ff00";
              msgDiv.style.fontSize = "24px";

              this.el.setAttribute("animation", {
                property: "position",
                to: "0 5 -6.9",
                dur: 1000,
              });

              setTimeout(() => {
                stopLevelTimer();
                unlockLevel(2);
                window.location.href = "nivel2-simples.html";
              }, 2000);
            } else {
              msgDiv.textContent = `Você precisa de ${3 - keysFound} chaves!`;
              msgDiv.style.color = "#ff0000";
              setTimeout(() => {
                msgDiv.textContent = "Encontre as chaves!";
                msgDiv.style.color = "white";
              }, 2000);
            }
          });
        },
      });

      document
        .querySelectorAll(".key")
        .forEach((key) => key.setAttribute("key-pickup", ""));
      document.getElementById("door").setAttribute("door-system", "");
    </script>
  </body>
</html>
